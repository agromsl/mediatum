(function($){$.fn.optionTree=function(tree,options){options=$.extend({choose:"Choose...",show_multiple:false,preselect:{},loading_image:"",select_class:"",leaf_class:"final",empty_value:"",on_each_change:false,set_value_on:"leaf",indexed:false,preselect_only_once:false},options||{});var cleanName=function(name){return name.replace(/_*$/,"")};var removeNested=function(name){$("select[name^='"+name+"']").remove()};var setValue=function(name,value){$("input[name='"+cleanName(name)+"']").val(value).change()};var default_lazy_load=function(value){var input=this;if(options.loading_image!==""){$("<img>").attr("src",options.loading_image).attr("class","optionTree-loader").insertAfter(input);console.log(input)}$.getJSON(options.lazy_load,{id:value},function(tree){$(".optionTree-loader").remove();var prop;for(prop in tree){if(tree.hasOwnProperty(prop)){$(input).optionTree(tree,options);return}}$(input).optionTree(value,options)})};if(typeof options.on_each_change==="string"){options.lazy_load=options.on_each_change;options.on_each_change=default_lazy_load}var isPreselectedFor=function(clean,v){if(!options.preselect||!options.preselect[clean]){return false}if($.isArray(options.preselect[clean])){return $.inArray(v,options.preselect[clean])!==-1}return options.preselect[clean]===v};return this.each(function(){var name=$(this).attr("name")+"_";removeNested(name);if(typeof tree==="object"){var $select=$("<select>").attr("name",name).change(function(){if(this.options[this.selectedIndex].value!==""){if($.isFunction(options.on_each_change)){removeNested(name+"_");options.on_each_change.apply(this,[this.options[this.selectedIndex].value,tree])}else{$(this).optionTree(tree[this.options[this.selectedIndex].value],options)}if(options.set_value_on==="each"){setValue(name,this.options[this.selectedIndex].value)}}else{removeNested(name+"_");setValue(name,options.empty_value)}});var text_to_choose="";if(jQuery.isFunction(options.choose)){var level=$(this).siblings().andSelf().filter("select").length;text_to_choose=options.choose.apply(this,[level])}else if(options.choose!==""){text_to_choose=options.choose}var count_tree_objects=0;if(text_to_choose!==""){count_tree_objects++}if(options.show_multiple>1){count_tree_objects=options.show_multiple}else if(options.show_multiple===true){$.each(tree,function(){count_tree_objects++})}if(count_tree_objects>1){$select.attr("size",count_tree_objects)}if($(this).is("input")){$select.insertBefore(this)}else{$select.insertAfter(this)}if(options.select_class){$select.addClass(options.select_class)}if(text_to_choose!==""){$("<option>").html(text_to_choose).val("").appendTo($select)}var foundPreselect=false;$.each(tree,function(k,v){var label,value;if(options.indexed){label=v;value=k}else{label=value=k}var o=$("<option>").html(label).attr("value",value);var clean=cleanName(name);if(options.leaf_class&&typeof value!=="object"){o.addClass(options.leaf_class)}o.appendTo($select);if(isPreselectedFor(clean,value)){o.get(0).selected=true;foundPreselect=true}});if(foundPreselect){$select.change()}if(!foundPreselect&&options.preselect_only_once){options.preselect[cleanName(name)]=null}}else if(options.set_value_on==="leaf"){if(options.indexed){setValue(name,this.options[this.selectedIndex].value)}else{setValue(name,tree)}}})}})(jQuery);